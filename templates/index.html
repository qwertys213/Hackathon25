<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Camera Object Analyzer</title>
    <link rel="icon" type="image/jpeg" href="/static/logo.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
        }

        h2, h3 {
            text-align: center;
            margin-bottom: 10px;
        }

        /* Video container */
        #camera {
            width: 100%;
            max-width: 500px;
            height: auto;
            display: block;
            margin: 0 auto;
            border-radius: 10px;
            border: 2px solid #333;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
        }

        /* Item buttons grid */
        #results {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        #results button {
            padding: 10px 16px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #1f1f1f;
            color: #eee;
            cursor: pointer;
            transition: 0.2s;
        }

        #results button:hover {
            background-color: #333;
        }

        /* Image preview card */
        #imageViewer {
            margin-top: 25px;
            text-align: center;
        }

        #imageViewer img {
            max-width: 100%;
            border-radius: 12px;
            border: 2px solid #444;
            margin-top: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Mobile spacing */
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            #results button {
                flex: 1 1 45%;
            }
        }
        #searchBar {
            width: 90%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
            margin: 10px auto 0 auto;
            display: block;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #1a1a1a;
            color: #eee;
        }
        #searchBar:focus {
            outline: none;
            border-color: #666;
        }
        #header {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
        }

        #header #logo {
            width: 50px;
            height: auto;
        }


    </style>
</head>
<body>

<div id="header">
    <img id="logo" src="/static/logo.jpg" alt="Logo">
    <h2>Camera Object Analyzer</h2>
</div>

<video id="camera" autoplay muted playsinline></video>

<h3>Detected Items:</h3>

<!-- NEW: Search bar -->
<input id="searchBar" type="text" placeholder="Search items..." oninput="filterItems()">

<div id="results"></div>

<div id="imageViewer"></div>

<script>
const video = document.getElementById("camera");
const resultsDiv = document.getElementById("results");
const imageViewer = document.getElementById("imageViewer");

let backCameraId = null;
let lastClickedImage = null;

// Find back camera
async function findBackCamera() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    for (let d of devices) {
        if (d.kind === "videoinput" &&
            (d.label.toLowerCase().includes("back") ||
             d.label.toLowerCase().includes("rear") ||
             d.label.toLowerCase().includes("environment"))) {
            return d.deviceId;
        }
    }
    for (let d of devices) if (d.kind === "videoinput") return d.deviceId;
    return null;
}
function filterItems() {
    const search = document.getElementById("searchBar").value.toLowerCase();
    const buttons = resultsDiv.querySelectorAll("button");

    buttons.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(search)) {
            btn.style.display = "inline-block";
        } else {
            btn.style.display = "none";
        }
    });
}

// Start camera
async function startCamera() {
    if (!backCameraId) backCameraId = await findBackCamera();
    if (!backCameraId) return alert("No back camera found.");

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { deviceId: { exact: backCameraId }, facingMode: "environment" }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => startAutoCapture();
    } catch (err) {
        console.error(err);
        alert("Cannot access the back camera.");
    }
}

// Auto-capture loop
async function startAutoCapture() {
    while (true) {
        if (!video.videoWidth || !video.videoHeight) {
            await new Promise(r => setTimeout(r, 100));
            continue;
        }

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
        const formData = new FormData();
        formData.append("image", blob, "capture.jpg");

        try {
            const response = await fetch("/analyze", { method: "POST", body: formData });
            const data = await response.json();
            displayDetectedItems(data.items);
        } catch (err) {
            console.error("Error:", err);
        }

        await new Promise(r => setTimeout(r, 2000));
    }
}

// Display detected items
function displayDetectedItems(items) {
    resultsDiv.innerHTML = "";
    if (!items || items.length === 0) {
        resultsDiv.textContent = "No objects detected.";
        return;
    }

    items.forEach(item => {
    const btn = document.createElement("button");
    btn.textContent = item.label;
    btn.onclick = () => {
        lastClickedImage = item.image;
        showImage(lastClickedImage);
    };
    resultsDiv.appendChild(btn);
});

// Re-apply search filter after new items appear
filterItems();


    if (lastClickedImage) showImage(lastClickedImage);
}

// Show image preview
function showImage(url) {
    imageViewer.innerHTML = `
        <h3>Selected Item</h3>
        <img src="${url}">
    `;
}

startCamera();
</script>

</body>
</html>
